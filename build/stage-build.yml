parameters:
- name: applicationEnvironment
  type: string
  default: ''
- name: androidKeyStoreFile
  type: string
  default: ''
- name: androidVariableGroup
  type: string
  default: ''
- name: iosCertificateFile
  type: string
  default: ''
- name: iosProvisioningProfileFile
  type: string
  default: ''
- name: iosVariableGroup
  type: string
  default: ''
- name: additionalReleaseNotesFile
  type: string
  default: 'Canary.md'
- name: removeHyperlinksFromReleaseNotes
  type: boolean
  default: false
- name: pathToSrc
  type: string
  default: '$(Build.SourcesDirectory)/src'
- name: solutionFileName
  type: string
  default: '$(SolutionFileName)'
- name: pathToInfoPlist
  type: string
  default: '$(InfoPlistPath)'
- name: pathToAndroidManifest
  type: string
  default: '$(AndroidManifestPath)'

jobs:
  - job: On_Windows_ReleaseNotes
    pool:
      name: $(windowsPoolName)
    variables:
      ArtifactName: ReleaseNotes_${{ parameters.applicationEnvironment }}
      ApplicationEnvironment: ${{ parameters.applicationEnvironment }}

    container: windows

    steps:
      - template: steps-build-release-notes.yml
        parameters:
          additionalReleaseNotesFile: ${{ parameters.additionalReleaseNotesFile }}
          removeHyperlinksFromReleaseNotes: ${{ parameters.removeHyperlinksFromReleaseNotes }}

  - job: On_Windows # Build UWP and Android on a windows machine
    strategy:
      maxParallel: 3
      matrix:
        Android:
          ApplicationConfiguration: Release_Android
          ApplicationPlatform: Any CPU
          ArtifactName: $(AndroidArtifactName)_${{ parameters.applicationEnvironment }}
          ApplicationEnvironment: ${{ parameters.applicationEnvironment }}
        UWP:
          ApplicationConfiguration: Release_UWP
          ApplicationPlatform: Any CPU
          ArtifactName: $(UWPArtifactName)_${{ parameters.applicationEnvironment }}
          ApplicationEnvironment: ${{ parameters.applicationEnvironment }}
        Tests:
          ApplicationConfiguration: Release_Tests
          ApplicationPlatform: Any CPU
          ArtifactName: $(TestsArtifactName)_${{ parameters.applicationEnvironment }}
          ApplicationEnvironment: ${{ parameters.applicationEnvironment }}

    pool:
      name: $(windowsPoolName)

    variables:
    - group: ${{ parameters.androidVariableGroup }}

    container: windows

    steps:
      - template: steps-build.yml
        parameters:
          pathToSrc: ${{ parameters.pathToSrc }}
          solutionFileName: ${{ parameters.solutionFileName }}
          androidKeyStoreFile: ${{ parameters.androidKeyStoreFile }}
          pathToAndroidManifest: ${{ parameters.pathToAndroidManifest }}

  - job: On_Mac # Build iOS on a mac
    strategy:
      maxParallel: 3
      matrix:
        iOS:
          ApplicationConfiguration: Release_iOS
          ApplicationPlatform: Any CPU
          ArtifactName: $(iOSArtifactName)_${{ parameters.applicationEnvironment }}
          ApplicationEnvironment: ${{ parameters.applicationEnvironment }}
    pool:
      name: $(macOSPoolName)
      vmImage: macos-12

    variables:
    - name: SkipUnknownFrameworks
      value: true # Used by TargetFrameworks.Filtering package to build only what's possible on a mac for the multitargeted library
    - group: ${{ parameters.iosVariableGroup }}

    steps:
    - template: steps-build.yml
      parameters:
        pathToSrc: ${{ parameters.pathToSrc }}
        solutionFileName: ${{ parameters.solutionFileName }}
        pathToInfoPlist: ${{ parameters.pathToInfoPlist }}
        iosProvisioningProfileFile: ${{ parameters.iosProvisioningProfileFile }}
        iosCertificateFile: ${{ parameters.iosCertificateFile }}
        iosCertificatePassword: $(AppleCertificatePassword)